# 源代码注释说明

## 概述

本项目是一个基于 Cloudflare Workers 的 VLESS 协议代理实现，包含两个主要文件：

- **worker.js**：功能完整版，支持 KV 存储、登录页面、动态配置
- **snippets.js**：简化版，单文件架构，直接部署使用

**共同特性**：

- NAT64、SOCKS5、多种代理模式
- WebSocket 数据转发
- DNS over HTTPS 代理

## Base64 解码结果

通过运行 `decode-base64.js` 程序，我们解码了以下内容：

### worker.js 中的 Base64 编码内容

| 编码字符串                                                         | 解码结果                                           | 用途                  |
| ------------------------------------------------------------------ | -------------------------------------------------- | --------------------- |
| `ZWM4NzJkOGYtNzJiMC00YTA0LWI2MTItMDMyN2Q4NWUxOGVk`                 | `ec872d8f-72b0-4a04-b612-0327d85e18ed`             | VLESS 用户 ID（UUID） |
| `NDQz`                                                             | `443`                                              | 默认代理端口          |
| `cHJveHlpcC5hbWNsdWJzLmNhbWR2ci5vcmc=`                             | `proxyip.amclubs.camdvr.org`                       | 代理服务器地址 1      |
| `cHJveHlpcC5hbWNsdWJzLmtvem93LmNvbQ==`                             | `proxyip.amclubs.kozow.com`                        | 代理服务器地址 2      |
| `aHR0cHM6Ly8xLjEuMS4xL2Rucy1xdWVyeQ==`                             | `https://1.1.1.1/dns-query`                        | DNS over HTTPS 服务   |
| `MjYwMjpmYzU5OmIwOjY0Ojo=`                                         | `2602:fc59:b0:64::`                                | NAT64 IPv6 前缀       |
| `5pWw5a2X5aWX5Yip`                                                 | 编码问题                                           | 项目名称（中文）      |
| `EBMbCxUX`                                                         | `datatype`                                         | XOR 编码密钥          |
| `aHR0cHM6Ly95b3V0dWJlLmNvbS9AYW1fY2x1YnM/c3ViX2NvbmZpcm1hdGlvbj0x` | `https://youtube.com/@am_clubs?sub_confirmation=1` | YouTube 频道链接      |
| `aHR0cHM6Ly90Lm1lL2FtX2NsdWJz`                                     | `https://t.me/am_clubs`                            | Telegram 频道链接     |
| `aHR0cHM6Ly9naXRodWIuY29tL2FtY2x1YnMvYW0tY2YtdHVubmVs`             | `https://github.com/amclubs/am-cf-tunnel`          | GitHub 仓库链接       |
| `aHR0cHM6Ly9hbWNsdWJzcy5jb20=`                                     | `https://amclubss.com`                             | Blog 链接             |
| `UFJOVF9UWVBF`                                                     | `PROT_TYPE`                                        | 协议类型参数名        |

### snippets.js 中的 Base64 编码内容

| 编码字符串 | 解码结果 | 用途           |
| ---------- | -------- | -------------- |
| `dmxlc3M=` | `vless`  | VLESS 协议类型 |

## 已添加的注释

### worker.js 注释

#### 1. 文件头部注释

- 项目介绍和功能特性
- 作者联系方式
- Base64 编码说明

#### 2. 配置区域注释

- **基础配置**：UUID、端口、代理服务器
- **NAT64 配置**：IPv6 转换设置
- **SOCKS5 配置**：代理认证信息
- **其他配置**：DNS、日志、项目信息
- **作者链接**：社交媒体和仓库链接

#### 3. 工具函数注释

- `log()` / `error()`：日志输出函数
- `isValidUserId()`：UUID v4 格式验证
- `unsafeStringify()` / `stringify()`：字节数组到 UUID 转换

### snippets.js 注释

#### 1. 文件头部注释

- 项目特色（单文件架构、无需构建工具）
- 功能特性列表
- 自动回退机制说明

#### 2. 配置常量注释

- **UUID**：VLESS 用户标识
- **DEFAULT_PROXY_IP**：默认代理服务器说明
- **NAT64_PREFIX**：NAT64 前缀说明
- **BEST_DOMAINS**：优选域名列表及其用途

#### 3. 函数注释

- **`fetch()`**：主请求处理函数，路由 WebSocket 和 HTTP 请求
- **`handle_sub()`**：订阅链接处理，返回 Base64 编码的 VLESS 配置
- **`gen_links()`**：生成多个 VLESS 订阅链接，包含 WebSocket 参数配置
- **`convertToRouteX()`**：IPv4 到 NAT64 IPv6 转换，详细转换过程
- **`resolveDomainToRouteX()`**：域名解析到 NAT64，使用 DoH 查询
- **`handle_ws()`**：WebSocket 处理核心，VLESS 协议解析
- **`socks5Connect()`**：SOCKS5 代理连接，详细的三步握手过程
- **数据流处理**：UUID 验证、协议解析、连接回退机制
- **DNS 代理**：UDP DNS 请求处理和 DoH 转发
- **TCP 连接**：四种连接方式的尝试顺序（直连、SOCKS5、代理、NAT64）

## 待继续添加注释的函数

### worker.js（功能完整版）

#### 核心功能函数

1. **b64ToBuf()** - Base64 转 ArrayBuffer
2. **decodeBase64Utf8()** - Base64 UTF-8 解码
3. **requestParser()** - SOCKS5 配置解析
4. **xorEn() / xorDe()** - XOR 加密/解密
5. **getDomainToRouteX()** - 域名路由决策
6. **matchesDomainPattern()** - 域名模式匹配
7. **resolveDomainToRouteX()** - 域名到 NAT64 解析
8. **convertToRouteX()** - IPv4 到 NAT64 IPv6 转换

#### WebSocket 处理

1. **websvcExecutor()** - 标准 WebSocket 处理
2. **websvcExecutorTr()** - TR 模式 WebSocket 处理
3. **websvcStream()** - WebSocket 流处理
4. **handleTPOut()** - TCP 输出处理
5. **handleUPOut()** - UDP 输出处理（DNS代理）
6. **transferDataStream()** - 数据流传输
7. **serviceCall()** - SOCKS5 服务调用

#### KV 存储管理

1. **check_kv()** - KV 存储检查
2. **get_kv()** - 获取 KV 数据
3. **set_kv_data()** - 设置 KV 数据
4. **show_kv_page()** - 显示配置页面

#### HTTP 请求处理

1. **handleRequestHeader()** - VLESS 请求头解析
2. **handleRequestHeaderTr()** - TR 模式请求头解析
3. **login()** - 登录页面
4. **renderPage()** - 页面渲染

### snippets.js（简化版）

✅ **已完成注释**：

- 所有主要函数均已添加详细注释
- 包括配置常量、工具函数、核心逻辑
- WebSocket 处理和数据转发逻辑已完整注释

## 使用说明

### 运行解码程序

```bash
node decode-base64.js
```

### 主要特性

- **VLESS 协议**：轻量级无加密代理协议
- **NAT64 支持**：IPv4 到 IPv6 的转换
- **多种代理模式**：直连、代理、NAT64、自动回退
- **SOCKS5 支持**：标准 SOCKS5 协议
- **DNS 代理**：支持 DoH (DNS over HTTPS)
- **动态配置**：通过 KV 存储动态配置域名规则

### URL 参数示例

- `/?mode=direct` - 仅直连
- `/?mode=nat64` - 仅 NAT64 模式
- `/?mode=auto&direct&nat64&proxyip=1.2.3.4:443` - 自动模式，灵活回退
- `/?ENABLE_LOG=true` - 启用详细日志

## 技术要点

1. **Base64 编码**：用于隐藏敏感配置信息
2. **UUID v4**：VLESS 协议的用户标识格式
3. **NAT64**：将 IPv4 地址嵌入到 IPv6 前缀中
4. **WebSocket**：作为代理的传输协议
5. **KV 存储**：Cloudflare 的键值存储，用于动态配置
6. **SOCKS5**：标准的代理协议

## 注意事项

- 本代码仅供学习和研究使用
- 请遵守当地法律法规
- 使用前请确保理解代理协议的工作原理
- 部署时请修改默认的 UUID 和配置
